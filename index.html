<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Miami Beach Weather & Tides</title>
  <meta http-equiv="cache-control" content="no-cache" />
  <meta http-equiv="expires" content="0" />
  <meta http-equiv="pragma" content="no-cache" />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: transparent;
      font-family: 'Open Sans', sans-serif;
      color: white;
    }
    .badge {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 16px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 1);
      min-width: 260px;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .location {
      font-size: 14px;
      font-weight: bold;
    }
    .temp, .time {
      font-size: 15px;
    }
    .info {
      font-size: 13px;
      color: #ccc;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <div class="badge">
    <div class="row">
      <img id="icon" src="" alt="Weather Icon" width="36" height="36" />
      <div>
        <div class="location" id="location">Miami Beach</div>
        <div class="time" id="time">--:--</div>
        <div class="temp" id="temp">--°F</div>
        <div class="info">🌅 Sunset: <span id="sunset">--:--</span></div>
        <div class="info">🌊 Next H/L Tide: <span id="tides">--</span></div>
      </div>
    </div>
  </div>

  <script>
    const API_KEY = '6f6de3f249f61942a63e42cd76f89252'; // OpenWeather
    const CITY = 'Miami Beach';
    const NOAA_STATION = '8723170';

    async function fetchNextTides() {
      const now = new Date();
      const today = now.toISOString().split("T")[0];
      const url = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?product=predictions&station=${NOAA_STATION}&datum=MLLW&time_zone=lst_ldt&units=english&format=json&interval=hilo&date=${today}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        if (!data.predictions) return '--';

        const future = data.predictions
          .map(p => ({ ...p, dt: new Date(p.t.replace(' ', 'T')) }))
          .filter(p => p.dt > now);

        const nextLow = future.find(p => p.type === 'L');
        const nextHigh = future.find(p => p.type === 'H');

        const format = dt => dt.toLocaleTimeString('en-US', {
          timeZone: 'America/New_York',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });

        const lowText = nextLow ? `${format(nextLow.dt)} (Low)` : '';
        const highText = nextHigh ? `${format(nextHigh.dt)} (High)` : '';
        return [highText, lowText].filter(Boolean).join(', ');
      } catch (err) {
        console.error('Tide fetch error:', err);
        return '--';
      }
    }
async function fetchNextTides() {
  const now = new Date();
  const today = now.toISOString().split("T")[0];
  const url = `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?product=predictions&station=8723170&datum=MLLW&time_zone=lst_ldt&units=english&format=json&interval=hilo&date=${today}`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    console.log("⛵ NOAA raw predictions:", data.predictions);
    if (!data.predictions) return '--';

    const future = data.predictions
      .map(p => {
        const dt = new Date(p.t.replace(' ', 'T'));
        console.log(`  - ${p.type} at ${p.t} → parsed: ${dt.toISOString()}`);
        return { ...p, dt };
      })
      .filter(p => p.dt > now);

    console.log("🌊 Future events:", future);

    const nextLow = future.find(p => p.type === 'L');
    const nextHigh = future.find(p => p.type === 'H');

    if (!nextLow && !nextHigh) {
      console.warn("⚠️ No upcoming tides found.");
      return '--';
    }

    const format = dt => dt.toLocaleTimeString('en-US', {
      timeZone: 'America/New_York',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });

    const lowText = nextLow ? `${format(nextLow.dt)} (Low)` : '';
    const highText = nextHigh ? `${format(nextHigh.dt)} (High)` : '';
    const final = [highText, lowText].filter(Boolean).join(', ');
    console.log("✅ Final Tide String:", final);

    return final;
  } catch (err) {
    console.error('💥 Tide fetch error:', err);
    return '--';
  }
}
    function updateTime() {
      const now = new Date();
      document.getElementById('time').textContent = now.toLocaleTimeString('en-US', {
        timeZone: 'America/New_York',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateAll();
      updateTime();
      setInterval(updateAll, 300000); // every 5 min
      setInterval(updateTime, 60000); // every 1 min
    });
  </script>
</body>
</html>
